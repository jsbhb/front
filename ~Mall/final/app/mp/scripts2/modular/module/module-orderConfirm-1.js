define(["config.page.render"],function(e){"use strict";var o=window.capi.get(),t=o.jsData.platform.rule.crossOrder.maxPrice,n=o.jsData.platform.rule.normalOrder.minPrice;return e.extend({tags:{global:"<component-orderconfirm-1></component-orderconfirm-1>",payChoose:"<component-pay-choose-1></component-pay-choose-1>"},region:{global:{cfgDynamic:!0,reqDynamic:!0,resDynamic:!0,beforeFunc:function(e,o){if($.isEmptyObject(e.config.global.showDiscount)){var t=0,n=o.response.global.ordersInfo,r=o.response.discount||[],i={},c={superposition:{pool:{},chooseObj:{}},unSuperposition:{pool:{},chooseObj:{}}};i[0]={},i[1]={},i[2]={},i[3]={},i[4]={},$.each(r,function(e,o){var t=o.name;o.name=t.split("/")[0],o.type=t.split("/")[1]||"",i[o.rule.range][o.couponId]=o}),$.each(n.typeObj,function(o,n){$.each(n,function(n,r){var s={type:r.type,info:{superposition:{pool:[],chooseArr:[]},unSuperposition:{pool:[],choose:"-1"}},supplierId:r.supplierId},a={};t++,a[0]={price:r.supplierPrice},a[1]={},a[2]={},a[3]={},a[4]={},$.each(r.itemObj,function(e,o){a[1][o.firstCategory]=a[1][o.firstCategory]||{},a[2][o.secondCategory]=a[2][o.secondCategory]||{},a[3][o.thirdCategory]=a[3][o.thirdCategory]||{},a[4][o.goodsId]=a[4][o.goodsId]||{};var t=a[1][o.firstCategory].price||0,n=a[2][o.secondCategory].price||0,r=a[3][o.thirdCategory].price||0;a[1][o.firstCategory].price=t+o.quantity*o.realPrice,a[2][o.secondCategory].price=n+o.quantity*o.realPrice,a[3][o.thirdCategory].price=r+o.quantity*o.realPrice,a[4][o.goodsId].price=o.quantity*o.realPrice}),$.each(a,function(e,o){$.each(o,function(o,t){var n="1"===e||"2"===e||"3"===e;"0"===e?$.each(i[e],function(e,o){1*t>=o.rule.condition&&(0!==o.rule.superposition?s.info.superposition.pool.push(o.couponId):s.info.unSuperposition.pool.push(o.couponId),0!==o.rule.superposition?c.superposition.pool[o.couponId]=o:c.unSuperposition.pool[o.couponId]=o)}):"4"===e?$.each(i[e],function(e,n){$.each(n.rule.bindingList,function(e,r){o==r.goodsId&&1*t.price>=n.rule.condition&&(0!==n.rule.superposition?s.info.superposition.pool.push(n.couponId):s.info.unSuperposition.pool.push(n.couponId),0!==n.rule.superposition?c.superposition.pool[n.couponId]=n:c.unSuperposition.pool[n.couponId]=n,t.couponId=n.couponId)})}):n&&$.each(i[e],function(e,n){o==n.rule.category&&1*t.price>=n.rule.condition&&(0!==n.rule.superposition?s.info.superposition.pool.push(n.couponId):s.info.unSuperposition.pool.push(n.couponId),0!==n.rule.superposition?c.superposition.pool[n.couponId]=n:c.unSuperposition.pool[n.couponId]=n,t.couponId=n.couponId)})})}),e.response.global.ordersInfo.orderCount=t,e.response.global.ordersInfo.typeObj[o][n].goodsTypeObj=a,e.response.global.ordersInfo.typeObj[o][n].discountPrice=0,e.response.global.ordersInfo.typeObj[o][n].orderDiscount=s})}),e.config.global.showDiscount=c,window.localStorage.setItem("showDiscount",JSON.stringify(c||{})),window.localStorage.setItem("ordersInfo",JSON.stringify(e.response.global.ordersInfo||{}))}},afterFunc:function(e,o){var t=[],n={},r=e.renderData.global.config.centerId,i=o.response.global.ordersInfo||{},c=o.config.global.address.province;$.each(i.typeObj,function(e,o){"0"===e&&$.each(o,function(o,i){var s=i.supplierPrice,a=i.supplierWeight;$.each(i.itemObj,function(i,p){0==p.freePost&&(n[o]=e,c&&s&&a&&t.push({centerId:r,supplierId:o,province:c,weight:a,price:s}))})})}),t&&t.length>0&&e.sendRequest("ORDER_USER_POSTFEE",{data:encodeURI(JSON.stringify(t))}).done(function(o){o&&o.success&&$.each(o.obj,function(o,t){var r=t.supplierId,i=n[r];e.renderData.global.response.ordersInfo.typeObj[i][r].attr("postFee",t.postFee||0)})})}},payChoose:{cfgDynamic:!0}},config:{global:{},payChoose:{payChooseShow:!1,payState:null}},request:{COUPON_USERLIST_QUERY:{status:0}},response:{global:{}},sendArr:["COUPON_USERLIST_QUERY/discount"],reload:!0,".component-orderConfirm-orderDetails .commodity-coupon touchend":function(e){var o=this,t=$(e),n=!0,r=!1,i=o.modules.message,c=t.parents(".goodsList"),s=o.config.global.pathUrl,a=o.renderData.global.response.ordersInfo.attr(),p=o.renderData.global.config.showDiscount.attr(),l=c.attr("type"),u=c.attr("supplierId"),d=a.typeObj[l][u],f=d.orderDiscount,m=f.info.superposition.chooseArr.join(",")||"",y=f.info.unSuperposition.choose||"-1";if(m||y&&"-1"!==y?r=!0:$.each(f.info,function(e,o){$.each(o.pool,function(e,o){if(!n)return!1;n=!1,r=!0})}),r){var g=JSON.stringify(d||{}),h=JSON.stringify(a||{}),I=JSON.stringify(p||{});window.localStorage.setItem("orderInfo",g),window.localStorage.setItem("ordersInfo",h),window.localStorage.setItem("showDiscount",I),window.location.href="/discount.html?type=orderConfirm&jumpUrl="+s+"&choose1="+m+"&choose2="+y}else i.refresh({content:"该订单暂无可使用的优惠券！",cancelBtn:!1,confirmBtn:!1})},".component-orderConfirm-content .commodity-payBtn .btn_commit touchend":function(e){var r=this,i=$(e),c={},s=[],a=[],p=r.element,l=r.modules.message,u=r.config.global.jumpUrl,d=r.config.global.pathUrl,f=r.config.global.redirect,m=i.parents(".goodsList");if(o.jsEvent.touch.focusTime<=500)return null;var y=m.attr("type"),g=m.attr("supplierId"),h=r.config.global.address,I=r.renderData.global.response.ordersInfo,b=I.typeObj[y][g].attr(),j=b.orderDiscount.info.superposition.chooseArr,O=b.orderDiscount.info.unSuperposition.choose,w=I.attr("orderCount"),S=window.localStorage.getItem("openId"),D=window.localStorage.getItem("pushUserId"),C=0,v=p.find(".commodity-remark input").val()||"",P=!1,T=!1;r.renderData.payChoose.config.attr("payChooseShow",!0),r.renderData.payChoose.config.attr("orderFlag",y),r.renderData.payChoose.config.attr("payState",$.Deferred());var E=0,U={},F=[];if(U.receiveName=h.receiveName,U.receivePhone=h.receivePhone,U.receiveProvince=h.province,U.receiveCity=h.city,U.receiveArea=h.area,U.receiveAddress=h.address,U.payment=1*b.orderPrice-1*b.discountPrice,U.postFee=b.postFee,U.taxFee=b.taxFee,$.each(b.itemObj,function(e,o){if(o.ids&&s.push(o.ids),F.push({sku:o.sku,itemId:o.itemId,goodsId:o.goodsId,itemCode:o.itemCode,itemName:o.goodsName,itemImg:o.itemImg,itemInfo:o.info,itemQuantity:o.quantity,itemPrice:o.price,actualPrice:o.realPrice}),!o.stock||o.stock<=0)return P=!0,T=o.goodsName,!1;C=o.tagFunId||0,E++}),P)return void l.refresh({title:"库存不足",content:"该订单"+T+"商品库存不足，是否返回上页调整？",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){r.jsUtil.url.jumpPage(u,null,!0)}});c={tdq:E,openId:S,supplierId:g,orderDetail:U,orderGoodsList:F,createType:1===C?4:0,expressType:0,orderSource:1,orderFlag:y,pushUserId:D,redirect:f,tagFun:C,remark:v},O&&"-1"!==O&&a.push(O),$.each(j,function(e,o){a.push(o)}),a.length>0&&(c.couponIds=a.join(",")),$.when(r.renderData.payChoose.config.attr().payState).done(function(e){var o=function(){},i=function(){I.attr("orderCount",w),I.typeObj[y][g].attr("commitText","提交成功"),window.localStorage.setItem("ordersInfo",JSON.stringify(I.attr())),window.localStorage.removeItem("pushUserId")},a=function(){I.typeObj[y].removeAttr(g),w<=0&&I.removeAttr("orderCount"),$.isEmptyObject(I.typeObj[y].attr())&&I.typeObj.removeAttr(y),$.isEmptyObject(I.typeObj.attr())&&I.removeAttr("typeObj"),window.localStorage.setItem("ordersInfo",JSON.stringify(I.attr())),w<=0&&window.location.replace("/orderList.html")},p=function(){var e=I.attr();delete e.typeObj[y][g],w<=0&&delete e.orderCount,$.isEmptyObject(e.typeObj[y])&&delete e.typeObj[y],$.isEmptyObject(e.typeObj)&&delete e.typeObj,window.localStorage.setItem("ordersInfo",JSON.stringify(e)),window.localStorage.removeItem("sendToYinLian"),window.localStorage.removeItem("sendToAliPay")};I.typeObj[y][g].attr("committed",!0),I.typeObj[y][g].attr("commitText","正在提交.."),"weChatPay"===e&&(c.type="JSAPI",c.payType=c.orderDetail.payType=1,o=function(e){r.jsUtil.weChat.toPay("JSAPI",e.obj,{success:a,cancel:a})}),"aliPay"===e&&(c.type="scanCode",c.payType=c.orderDetail.payType=2,o=function(e){if(e.obj){p();var o="string"==typeof e.obj?e.obj:JSON.stringify(e.obj);window.localStorage.setItem("sendToAliPay",o),window.location.href="/pay-transfer.html"}}),"ybPay"===e&&(c.type="",c.payType=c.orderDetail.payType=5,o=function(e){e.obj&&(window.location.href=e.obj.url)}),"unionPay"===e&&(c.type="08",c.payType=c.orderDetail.payType=3,o=function(e){if(e.obj){p();var o="string"==typeof e.obj?e.obj:JSON.stringify(e.obj);window.localStorage.setItem("sendToYinLian",o),window.location.href="/pay-transfer.html"}}),r.sendRequest("USER_DETAIL_QUERY").done(function(e){if(e&&e.success){if($.isPlainObject(e.obj))if($.isPlainObject(e.obj.userDetail)&&e.obj.userDetail.idNum){var a=0;0==y?c.orderDetail.payment>t&&(1===c.orderGoodsList.length&&1===c.orderGoodsList[0].itemQuantity||(a=1)):2==y&&c.orderDetail.payment<n&&1*c.supplierId==6&&(a=2),0==a?r.sendRequest("ORDER_USER_CREATE",c).done(function(e){e&&e.success?(w--,s.join(",")?r.sendRequest("ORDER_SHOPPINGCART_DELETE",{ids:s.join(",")}).done(function(){i(),o(e)}):(i(),o(e))):(l.refresh({type:"error",content:(e||{}).errorMsg||"提交订单失败！",cancelBtn:!1,confirmBtn:!1}),I.typeObj[y][g].attr("committed",!1),I.typeObj[y][g].attr("commitText","重新提交"),window.localStorage.setItem("ordersInfo",JSON.stringify(I.attr())))}).fail(function(e){l.refresh({type:"error",content:(e||{}).errorMsg||"提交订单失败！",cancelBtn:!1,confirmBtn:!1}),I.typeObj[y][g].attr("committed",!1),I.typeObj[y][g].attr("commitText","重新提交"),window.localStorage.setItem("ordersInfo",JSON.stringify(I.attr()))}):1==a?l.refresh({title:"温馨提示",content:"根据海关相关规定，单笔跨境订单金额不得超过"+t+"元，是否返回上页调整？",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){I.typeObj[y][g].attr("committed",!1),I.typeObj[y][g].attr("commitText","重新提交")},confirmFun:function(){r.jsUtil.url.jumpPage(u,null,!0)}}):2==a&&l.refresh({title:"温馨提示",content:"该笔一般贸易订单金额未满"+n+"元，是否返回上页调整？",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){I.typeObj[y][g].attr("committed",!1),I.typeObj[y][g].attr("commitText","重新提交")},confirmFun:function(){r.jsUtil.url.jumpPage(u,null,!0)}})}else l.refresh({title:"实名认证",content:"跨境订单需填写身份证信息, 请完善!",DOMClick:!1,cancelBtn:!1,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){window.location.href="/personal-information.html?jumpUrl="+d}})}else l.refresh({title:"实名认证",content:"跨境订单需填写身份证信息, 请完善!",DOMClick:!1,cancelBtn:!1,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){window.location.href="/personal-information.html?jumpUrl="+d}})})})}})});