define([],function(){"use strict";var e=window.capi.get(),t=$.each,n=$.when,s=$.extend,r=$.Deferred,o=$.isEmptyObject,i=$.isPlainObject,a=$.isFunction,l=$.isArray,c=$.inArray;return can.Control.extend({tags:{},region:{},config:{},request:{},response:{},renderData:{},sendArr:[],reload:!1,sendRequest:function(e,t,n){var o=this;return void 0===e?r().resolve():i(o.jsModel.path[e])?o.jsModel.send(e,s(!0,{},o.request[e],t||{}),n):r().reject()},setRenderData:function(e,t,n,s){var r=this,o=null,c=e.split("/"),u=c.shift()||"",f=c.shift()||"";r.renderData[u]||(r.renderData[u]={}),r.renderData[u][t]||(r.renderData[u][t]={});var d=r.renderData[u][t],h=a(d.attr),g=a(d),p=h?d.attr():g?d():d;f?i(p)&&(p[f]=n):p=n,o=s&&l(p)?new can.List(p):o,o=s&&i(p)?new can.Map(p):o,o=s&&!o?can.compute(p):o,r.renderData[u][t]=s?o:p,o=null,p=null},renderTemplate:function(e){var s=this,r=null,o=l(e),i=-1!==c("global",e);o&&i&&(e=[],e.unshift("global"),r=document.createDocumentFragment(),t(Object.keys(this.tags),function(t,n){"global"!==n&&e.push(n)})),n.apply(null,[].concat(s.queue)).done(function(){t(o?e:[],function(e,t){var n=s.tags[t],o="[region='"+t+"']",a=i?r.querySelector(o):s.element.find(o),l={module:s,root:s.renderData,region:s.renderData[t]},c="global"===t?r:a;null!==n&&void 0!==n&&t&&c&&(i?c.appendChild(can.mustache(n)(l)):c.html(can.mustache(n)(l)))}),o&&i&&s.element.html(r),"pending"===s.state.state()&&s.state.resolve()})},init:function(){this.jsUtil=e.jsUtil,this.jsModel=e.jsModel,this.jsEvent=e.jsEvent,this.modules=e.jsModular.modules,this.queue=e.jsEvent.page.state,this.state=e.jsEvent.page.state=r(),this.tags=s(!0,{global:{}},this.tags,this.options.tags),this.region=s(!0,{global:{}},this.region,this.options.region),this.config=s(!0,{global:{}},this.config,this.options.config),this.request=s(!0,{global:{}},this.request,this.options.request),this.response=s(!0,{global:{}},this.response,this.options.response),this.renderData=s(!0,{global:{}},this.renderData,this.options.renderData),this.sendArr=s(!0,[],this.sendArr,this.options.sendArr),this.reload=!0===this.reload||!0===this.options.reload,this.toRender(this.sendArr,[],Object.keys(this.tags),this.reload)},toRender:function(e,a,l,c){var u=this,f=!0,d=[],h=-1,g=r(),p=[].concat(e),b=[].concat(a),v=[].concat(l);return t(p,function(e,t){if("string"==typeof t&&t){var n=t.split("/"),s="string"==typeof n[0]&&n.shift()||"",a="string"==typeof n[0]&&n.shift()||"global",l="string"==typeof n[0]&&n.shift()||"",g=i(b[e])&&b[e]||{},p=o(u.response[a]);s&&(!1!==c||p)&&(d[++h]=r(),function(e){u.sendRequest(s,g,!0).done(function(t){var n=u.response[a];!i(n)&&(u.response[a]={}),!l&&(u.response[a]=t),l&&(u.response[a][l]=t),d[e].resolve()}).fail(function(){f=!1,d[e].resolve()})}(h))}}),n.apply(null,d).always(function(){var e={},t={},n={},r={config:u.config},o={request:u.request},i={response:u.response};s(!0,e,r,o,i),s(!0,t,r,o,i),s(!0,n,r,o,i),u.beforeFunc(v,e,f),u.renderFunc(v,t,f),u.afterFunc(v,n,f)}),u.renderState=g},beforeFunc:function(e,n,s){var r=this,o=r.region,u=l(e),f=c("global",e);u&&-1!==f&&(e.splice(f,1),e.unshift("global")),t(u?e:[],function(e,t){var s="object"==typeof t&&t,l=s?Object.keys(t)[0]:t;"string"==typeof l&&l&&r.tags[l]&&i(o[l])&&a(o[l].beforeFunc)&&o[l].beforeFunc(r,n)})},renderFunc:function(e,n,s){var r=this,o=[],a=l(e);$(function(){t(a?e.sort():[],function(e,t){var n="string"==typeof t&&t,s="object"==typeof t&&t,a=s?Object.keys(t)[0]:t,l=a.split("/")[0],u=r.region[l];if((n||s)&&o.push(l),i(u)||(r.region[l]={}),n||s){var f=r.config[l]||null,d=r.request[l]||null,h=r.response[l]||null,g=!0===r.region[l].cfgDynamic,p=!0===r.region[l].reqDynamic,b=!0===r.region[l].resDynamic,v=s&&-1!==c("config",[].concat(t[a])),y=s&&-1!==c("request",[].concat(t[a])),j=s&&-1!==c("response",[].concat(t[a]));(n||v)&&r.setRenderData(a,"config",f,g),(n||y)&&r.setRenderData(a,"request",d,p),(n||j)&&r.setRenderData(a,"response",h,b)}}),r.renderTemplate(o)})},afterFunc:function(e,s,r){var o=this,u=[],f=o.region,d=l(e),h=c("global",e);d&&-1!==h&&(e.splice(h,1),e.push("global")),$(function(){n.apply(null,[].concat(o.queue)).done(function(){t(d?e:[],function(e,t){var n="object"==typeof t&&t,r=n?Object.keys(t)[0]:t;"string"==typeof r&&r&&o.tags[r]&&i(f[r])&&a(f[r].afterFunc)&&(u[u.length]=f[r].afterFunc(o,s))}),n.apply(null,u).done(function(){r?o.renderState.resolve():o.renderState.reject()}).fail(function(){o.renderState.reject()})})})}})});