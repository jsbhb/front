define(["config.page.render"],function(o){"use strict";var e=window.capi.get(),t=e.jsData.platform.rule.crossOrder.maxPrice;return e.jsData.platform.rule.normalOrder.minPrice,o.extend({tags:{global:"<component-orderconfirm-1></component-orderconfirm-1>",payChoose:"<component-pay-choose-1></component-pay-choose-1>"},region:{global:{cfgDynamic:!0,reqDynamic:!0,resDynamic:!0,beforeFunc:function(o,e){if($.isEmptyObject(o.config.global.showDiscount)){var t=0,n=e.response.global.ordersInfo,r=e.response.discount||[],i={},s={superposition:{pool:{},chooseObj:{}},unSuperposition:{pool:{},chooseObj:{}}};i[0]={},i[1]={},i[2]={},i[3]={},i[4]={},$.each(r,function(o,e){var t=e.name;e.name=t.split("/")[0],e.type=t.split("/")[1]||"",i[e.rule.range][e.couponId]=e}),$.each(n.typeObj,function(e,n){$.each(n,function(n,r){var c={type:r.type,info:{superposition:{pool:[],chooseArr:[]},unSuperposition:{pool:[],choose:"-1"}},supplierId:r.supplierId},a={};t++,a[0]={price:r.supplierPrice},a[1]={},a[2]={},a[3]={},a[4]={},$.each(r.itemObj,function(o,e){a[1][e.firstCategory]=a[1][e.firstCategory]||{},a[2][e.secondCategory]=a[2][e.secondCategory]||{},a[3][e.thirdCategory]=a[3][e.thirdCategory]||{},a[4][e.goodsId]=a[4][e.goodsId]||{};var t=a[1][e.firstCategory].price||0,n=a[2][e.secondCategory].price||0,r=a[3][e.thirdCategory].price||0;a[1][e.firstCategory].price=t+e.quantity*e.realPrice,a[2][e.secondCategory].price=n+e.quantity*e.realPrice,a[3][e.thirdCategory].price=r+e.quantity*e.realPrice,a[4][e.goodsId].price=e.quantity*e.realPrice}),$.each(a,function(o,e){$.each(e,function(e,t){var n="1"===o||"2"===o||"3"===o;"0"===o?$.each(i[o],function(o,e){1*t>=e.rule.condition&&(0!==e.rule.superposition?c.info.superposition.pool.push(e.couponId):c.info.unSuperposition.pool.push(e.couponId),0!==e.rule.superposition?s.superposition.pool[e.couponId]=e:s.unSuperposition.pool[e.couponId]=e)}):"4"===o?$.each(i[o],function(o,n){$.each(n.rule.bindingList,function(o,r){e==r.goodsId&&1*t.price>=n.rule.condition&&(0!==n.rule.superposition?c.info.superposition.pool.push(n.couponId):c.info.unSuperposition.pool.push(n.couponId),0!==n.rule.superposition?s.superposition.pool[n.couponId]=n:s.unSuperposition.pool[n.couponId]=n,t.couponId=n.couponId)})}):n&&$.each(i[o],function(o,n){e==n.rule.category&&1*t.price>=n.rule.condition&&(0!==n.rule.superposition?c.info.superposition.pool.push(n.couponId):c.info.unSuperposition.pool.push(n.couponId),0!==n.rule.superposition?s.superposition.pool[n.couponId]=n:s.unSuperposition.pool[n.couponId]=n,t.couponId=n.couponId)})})}),o.response.global.ordersInfo.orderCount=t,o.response.global.ordersInfo.typeObj[e][n].goodsTypeObj=a,o.response.global.ordersInfo.typeObj[e][n].discountPrice=0,o.response.global.ordersInfo.typeObj[e][n].orderDiscount=c})}),o.config.global.showDiscount=s,window.localStorage.setItem("showDiscount",JSON.stringify(s||{})),window.localStorage.setItem("ordersInfo",JSON.stringify(o.response.global.ordersInfo||{}))}},afterFunc:function(o,e){var t=[],n={},r=o.renderData.global.config.centerId,i=e.response.global.ordersInfo||{},s=e.config.global.address.province;$.each(i.typeObj,function(o,e){$.each(e,function(e,i){var c=i.supplierPrice,a=i.supplierWeight;$.each(i.itemObj,function(i,p){0==p.freePost&&(n[e]=o,s&&c&&a&&t.push({centerId:r,supplierId:e,province:s,weight:a,price:c}))})})}),t&&t.length>0&&o.sendRequest("ORDER_USER_POSTFEE",{data:encodeURI(JSON.stringify(t))}).done(function(e){e&&e.success&&$.each(e.obj,function(e,t){var r=t.supplierId,i=n[r];o.renderData.global.response.ordersInfo.typeObj[i][r].attr("postFee",t.postFee||0)})})}},payChoose:{cfgDynamic:!0}},config:{global:{},payChoose:{payChooseShow:!1,payState:null}},request:{COUPON_USERLIST_QUERY:{status:0}},response:{global:{}},sendArr:["COUPON_USERLIST_QUERY/discount"],reload:!0,".component-orderConfirm-orderDetails .commodity-coupon touchend":function(o){var e=this,t=$(o),n=!0,r=!1,i=e.modules.message,s=t.parents(".goodsList"),c=e.config.global.pathUrl,a=e.renderData.global.response.ordersInfo.attr(),p=e.renderData.global.config.showDiscount.attr(),l=s.attr("type"),u=s.attr("supplierId"),d=a.typeObj[l][u],f=d.orderDiscount,m=f.info.superposition.chooseArr.join(",")||"",y=f.info.unSuperposition.choose||"-1";if(m||y&&"-1"!==y?r=!0:$.each(f.info,function(o,e){$.each(e.pool,function(o,e){if(!n)return!1;n=!1,r=!0})}),r){var g=JSON.stringify(d||{}),h=JSON.stringify(a||{}),I=JSON.stringify(p||{});window.localStorage.setItem("orderInfo",g),window.localStorage.setItem("ordersInfo",h),window.localStorage.setItem("showDiscount",I),window.location.href="/discount.html?type=orderConfirm&jumpUrl="+c+"&choose1="+m+"&choose2="+y}else i.refresh({content:"该订单暂无可使用的优惠券！",cancelBtn:!1,confirmBtn:!1})},".component-orderConfirm-content .commodity-payBtn .btn_commit touchend":function(o){var n=this,r=$(o),i={},s=[],c=[],a=n.element,p=n.modules.message,l=n.config.global.jumpUrl,u=n.config.global.pathUrl,d=n.config.global.redirect,f=r.parents(".goodsList");if(e.jsEvent.touch.focusTime<=500)return null;var m=f.attr("type"),y=f.attr("supplierId"),g=n.config.global.address,h=n.renderData.global.response.ordersInfo,I=h.typeObj[m][y].attr(),b=I.orderDiscount.info.superposition.chooseArr,j=I.orderDiscount.info.unSuperposition.choose,O=h.attr("orderCount"),w=window.localStorage.getItem("openId"),S=window.localStorage.getItem("pushUserId"),C=0,D=a.find(".commodity-remark input").val()||"",v=!1,P=!1;n.renderData.payChoose.config.attr("payChooseShow",!0),n.renderData.payChoose.config.attr("orderFlag",m),n.renderData.payChoose.config.attr("payState",$.Deferred());var T=0,E={},U=[];if(E.receiveName=g.receiveName,E.receivePhone=g.receivePhone,E.receiveProvince=g.province,E.receiveCity=g.city,E.receiveArea=g.area,E.receiveAddress=g.address,E.payment=1*I.orderPrice-1*I.discountPrice,E.postFee=I.postFee,E.taxFee=I.taxFee,$.each(I.itemObj,function(o,e){if(e.ids&&s.push(e.ids),U.push({sku:e.sku,itemId:e.itemId,goodsId:e.goodsId,itemCode:e.itemCode,itemName:e.goodsName,itemImg:e.itemImg,itemInfo:e.info,itemQuantity:e.quantity,itemPrice:e.price,actualPrice:e.realPrice}),!e.stock||e.stock<=0)return v=!0,P=e.goodsName,!1;C=e.tagFunId||0,T++}),v)return void p.refresh({title:"库存不足",content:"该订单"+P+"商品库存不足，是否返回上页调整？",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){n.jsUtil.url.jumpPage(l,null,!0)}});i={tdq:T,openId:w,supplierId:y,orderDetail:E,orderGoodsList:U,createType:1===C?4:0,expressType:0,orderSource:1,orderFlag:m,pushUserId:S,redirect:d,tagFun:C,remark:D},j&&"-1"!==j&&c.push(j),$.each(b,function(o,e){c.push(e)}),c.length>0&&(i.couponIds=c.join(",")),$.when(n.renderData.payChoose.config.attr().payState).done(function(o){var e=function(){},r=function(){h.attr("orderCount",O),h.typeObj[m][y].attr("commitText","提交成功"),window.localStorage.setItem("ordersInfo",JSON.stringify(h.attr())),window.localStorage.removeItem("pushUserId")},c=function(){h.typeObj[m].removeAttr(y),O<=0&&h.removeAttr("orderCount"),$.isEmptyObject(h.typeObj[m].attr())&&h.typeObj.removeAttr(m),$.isEmptyObject(h.typeObj.attr())&&h.removeAttr("typeObj"),window.localStorage.setItem("ordersInfo",JSON.stringify(h.attr())),O<=0&&window.location.replace("/orderList.html")},a=function(){var o=h.attr();delete o.typeObj[m][y],O<=0&&delete o.orderCount,$.isEmptyObject(o.typeObj[m])&&delete o.typeObj[m],$.isEmptyObject(o.typeObj)&&delete o.typeObj,window.localStorage.setItem("ordersInfo",JSON.stringify(o)),window.localStorage.removeItem("sendToYinLian"),window.localStorage.removeItem("sendToAliPay")};h.typeObj[m][y].attr("committed",!0),h.typeObj[m][y].attr("commitText","正在提交.."),"weChatPay"===o&&(i.type="JSAPI",i.payType=i.orderDetail.payType=1,e=function(o){n.jsUtil.weChat.toPay("JSAPI",o.obj,{success:c,cancel:c})}),"aliPay"===o&&(i.type="scanCode",i.payType=i.orderDetail.payType=2,e=function(o){if(o.obj){a();var e="string"==typeof o.obj?o.obj:JSON.stringify(o.obj);window.localStorage.setItem("sendToAliPay",e),window.location.href="/pay-transfer.html"}}),"ybPay"===o&&(i.type="",i.payType=i.orderDetail.payType=5,e=function(o){o.obj&&(window.location.href=o.obj.url)}),"unionPay"===o&&(i.type="08",i.payType=i.orderDetail.payType=3,e=function(o){if(o.obj){a();var e="string"==typeof o.obj?o.obj:JSON.stringify(o.obj);window.localStorage.setItem("sendToYinLian",e),window.location.href="/pay-transfer.html"}}),n.sendRequest("USER_DETAIL_QUERY").done(function(o){if(o&&o.success){if($.isPlainObject(o.obj))if($.isPlainObject(o.obj.userDetail)&&o.obj.userDetail.idNum){var c=0;0==m&&i.orderDetail.payment>t&&(1===i.orderGoodsList.length&&1===i.orderGoodsList[0].itemQuantity||(c=1)),0==c?n.sendRequest("ORDER_USER_CREATE",i).done(function(o){o&&o.success?(O--,s.join(",")?n.sendRequest("ORDER_SHOPPINGCART_DELETE",{ids:s.join(",")}).done(function(){r(),e(o)}):(r(),e(o))):(p.refresh({type:"error",content:(o||{}).errorMsg||"提交订单失败！",cancelBtn:!1,confirmBtn:!1}),h.typeObj[m][y].attr("committed",!1),h.typeObj[m][y].attr("commitText","重新提交"),window.localStorage.setItem("ordersInfo",JSON.stringify(h.attr())))}).fail(function(o){p.refresh({type:"error",content:(o||{}).errorMsg||"提交订单失败！",cancelBtn:!1,confirmBtn:!1}),h.typeObj[m][y].attr("committed",!1),h.typeObj[m][y].attr("commitText","重新提交"),window.localStorage.setItem("ordersInfo",JSON.stringify(h.attr()))}):1==c&&p.refresh({title:"温馨提示",content:"根据海关相关规定，单笔跨境订单金额不得超过"+t+"元，是否返回上页调整？",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){h.typeObj[m][y].attr("committed",!1),h.typeObj[m][y].attr("commitText","重新提交")},confirmFun:function(){n.jsUtil.url.jumpPage(l,null,!0)}})}else p.refresh({title:"实名认证",content:"跨境订单需填写身份证信息, 请完善!",DOMClick:!1,cancelBtn:!1,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){window.location.href="/personal-information.html?jumpUrl="+u}})}else p.refresh({title:"实名认证",content:"跨境订单需填写身份证信息, 请完善!",DOMClick:!1,cancelBtn:!1,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){window.location.href="/personal-information.html?jumpUrl="+u}})})})}})});