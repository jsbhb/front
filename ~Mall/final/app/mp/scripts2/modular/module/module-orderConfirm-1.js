define(["config.page.render"],function(e){"use strict";var o=window.capi.get(),t=o.jsData.platform.rule.crossOrder.maxPrice;return o.jsData.platform.rule.normalOrder.minPrice,e.extend({tags:{global:"<component-orderconfirm-1></component-orderconfirm-1>",payChoose:"<component-pay-choose-1></component-pay-choose-1>"},region:{global:{cfgDynamic:!0,reqDynamic:!0,resDynamic:!0,beforeFunc:function(e,o){if($.isEmptyObject(e.config.global.showDiscount)){var t=0,r=o.response.global.ordersInfo,n=o.response.discount||[],i={},s={superposition:{pool:{},chooseObj:{}},unSuperposition:{pool:{},chooseObj:{}}};i[0]={},i[1]={},i[2]={},i[3]={},i[4]={},$.each(n,function(e,o){var t=o.name;o.name=t.split("/")[0],o.type=t.split("/")[1]||"",i[o.rule.range][o.couponId]=o}),$.each(r.typeObj,function(o,r){$.each(r,function(r,n){var a={type:n.type,info:{superposition:{pool:[],chooseArr:[]},unSuperposition:{pool:[],choose:"-1"}},supplierId:n.supplierId},c={};t++,c[0]={price:n.supplierPrice},c[1]={},c[2]={},c[3]={},c[4]={},$.each(n.itemObj,function(e,o){c[1][o.firstCategory]=c[1][o.firstCategory]||{},c[2][o.secondCategory]=c[2][o.secondCategory]||{},c[3][o.thirdCategory]=c[3][o.thirdCategory]||{},c[4][o.goodsId]=c[4][o.goodsId]||{};var t=c[1][o.firstCategory].price||0,r=c[2][o.secondCategory].price||0,n=c[3][o.thirdCategory].price||0;c[1][o.firstCategory].price=t+o.quantity*o.realPrice,c[2][o.secondCategory].price=r+o.quantity*o.realPrice,c[3][o.thirdCategory].price=n+o.quantity*o.realPrice,c[4][o.goodsId].price=o.quantity*o.realPrice}),$.each(c,function(e,o){$.each(o,function(o,t){var r="1"===e||"2"===e||"3"===e;"0"===e?$.each(i[e],function(e,o){1*t>=o.rule.condition&&(0!==o.rule.superposition?a.info.superposition.pool.push(o.couponId):a.info.unSuperposition.pool.push(o.couponId),0!==o.rule.superposition?s.superposition.pool[o.couponId]=o:s.unSuperposition.pool[o.couponId]=o)}):"4"===e?$.each(i[e],function(e,r){$.each(r.rule.bindingList,function(e,n){o==n.goodsId&&1*t.price>=r.rule.condition&&(0!==r.rule.superposition?a.info.superposition.pool.push(r.couponId):a.info.unSuperposition.pool.push(r.couponId),0!==r.rule.superposition?s.superposition.pool[r.couponId]=r:s.unSuperposition.pool[r.couponId]=r,t.couponId=r.couponId)})}):r&&$.each(i[e],function(e,r){o==r.rule.category&&1*t.price>=r.rule.condition&&(0!==r.rule.superposition?a.info.superposition.pool.push(r.couponId):a.info.unSuperposition.pool.push(r.couponId),0!==r.rule.superposition?s.superposition.pool[r.couponId]=r:s.unSuperposition.pool[r.couponId]=r,t.couponId=r.couponId)})})}),e.response.global.ordersInfo.orderCount=t,e.response.global.ordersInfo.typeObj[o][r].goodsTypeObj=c,e.response.global.ordersInfo.typeObj[o][r].discountPrice=0,e.response.global.ordersInfo.typeObj[o][r].orderDiscount=a})}),e.config.global.showDiscount=s,window.localStorage.setItem("showDiscount",JSON.stringify(s||{})),window.localStorage.setItem("ordersInfo",JSON.stringify(e.response.global.ordersInfo||{}))}},afterFunc:function(e,o){var t=[],r={},n=e.renderData.global.config.centerId,i=o.response.global.ordersInfo||{},s=o.config.global.address.province;$.each(i.typeObj,function(e,o){$.each(o,function(o,i){var a=i.supplierPrice,c=i.supplierWeight;$.each(i.itemObj,function(i,p){0==p.freePost&&(r[o]=e,s&&a&&c&&t.push({centerId:n,supplierId:o,province:s,weight:c,price:a}))})})}),t&&t.length>0&&e.sendRequest("ORDER_USER_POSTFEE",{data:encodeURI(JSON.stringify(t))}).done(function(o){o&&o.success&&$.each(o.obj,function(o,t){var n=t.supplierId,i=r[n];e.renderData.global.response.ordersInfo.typeObj[i][n].attr("postFee",t.postFee||0)})})}},payChoose:{cfgDynamic:!0}},config:{global:{},payChoose:{payChooseShow:!1,payState:null}},request:{COUPON_USERLIST_QUERY:{status:0}},response:{global:{}},sendArr:["COUPON_USERLIST_QUERY/discount"],reload:!0,".component-orderConfirm-orderDetails .commodity-coupon touchend":function(e){var o=this,t=$(e),r=!0,n=!1,i=o.modules.message,s=t.parents(".goodsList"),a=o.config.global.pathUrl,c=o.renderData.global.response.ordersInfo.attr(),p=o.renderData.global.config.showDiscount.attr(),d=s.attr("type"),u=s.attr("supplierId"),l=c.typeObj[d][u],f=l.orderDiscount,m=f.info.superposition.chooseArr.join(",")||"",y=f.info.unSuperposition.choose||"-1";if(m||y&&"-1"!==y?n=!0:$.each(f.info,function(e,o){$.each(o.pool,function(e,o){if(!r)return!1;r=!1,n=!0})}),n){var g=JSON.stringify(l||{}),h=JSON.stringify(c||{}),I=JSON.stringify(p||{});window.localStorage.setItem("orderInfo",g),window.localStorage.setItem("ordersInfo",h),window.localStorage.setItem("showDiscount",I),window.location.href="/discount.html?type=orderConfirm&jumpUrl="+a+"&choose1="+m+"&choose2="+y}else i.refresh({content:"该订单暂无可使用的优惠券！",cancelBtn:!1,confirmBtn:!1})},".component-orderConfirm-content .commodity-payBtn .btn_commit touchend":function(e){var r=this,n=$(e),i={},s=[],a=[],c=r.element,p=r.modules.message,d=r.config.global.jumpUrl,u=r.config.global.pathUrl,l=r.config.global.redirect,f=n.parents(".goodsList");if(o.jsEvent.touch.focusTime<=500)return null;var m=f.attr("type"),y=f.attr("supplierId"),g=r.config.global.address,h=r.renderData.global.response.ordersInfo,I=h.typeObj[m][y].attr(),b=I.orderDiscount.info.superposition.chooseArr,j=I.orderDiscount.info.unSuperposition.choose,O=h.attr("orderCount"),S=window.localStorage.getItem("openId"),w=window.localStorage.getItem("pushUserId"),D=0,C=c.find(".commodity-remark input").val()||"",v=!1,P=!1;r.renderData.payChoose.config.attr("payChooseShow",!0),r.renderData.payChoose.config.attr("orderFlag",m),r.renderData.payChoose.config.attr("payState",$.Deferred());var T=0,E={},N=[];if(E.receiveName=g.receiveName,E.receivePhone=g.receivePhone,E.receiveProvince=g.province,E.receiveCity=g.city,E.receiveArea=g.area,E.receiveAddress=g.address,E.payment=1*I.orderPrice-1*I.discountPrice,E.postFee=I.postFee,E.taxFee=I.taxFee,$.each(I.itemObj,function(e,o){if(o.ids&&s.push(o.ids),N.push({sku:o.sku,itemId:o.itemId,goodsId:o.goodsId,itemCode:o.itemCode,itemName:o.goodsName,itemImg:o.itemImg,itemInfo:o.info,itemQuantity:o.quantity,itemPrice:o.price,actualPrice:o.realPrice,unit:o.unit}),!o.stock||o.stock<=0)return v=!0,P=o.goodsName,!1;D=o.tagFunId||0,T++}),v)return void p.refresh({title:"库存不足",content:"该订单"+P+"商品库存不足，是否返回上页调整？",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){r.jsUtil.url.jumpPage(d,null,!0)}});i={tdq:T,openId:S,supplierId:y,orderDetail:E,orderGoodsList:N,createType:1===D?4:0,expressType:0,orderSource:1,orderFlag:m,pushUserId:w,redirect:l,tagFun:D,remark:C},j&&"-1"!==j&&a.push(j),$.each(b,function(e,o){a.push(o)}),a.length>0&&(i.couponIds=a.join(",")),$.when(r.renderData.payChoose.config.attr().payState).done(function(e){var o=function(){},n=function(){h.attr("orderCount",O),h.typeObj[m][y].attr("commitText","提交成功"),window.localStorage.setItem("ordersInfo",JSON.stringify(h.attr())),window.localStorage.removeItem("pushUserId")},a=function(){h.typeObj[m].removeAttr(y),O<=0&&h.removeAttr("orderCount"),$.isEmptyObject(h.typeObj[m].attr())&&h.typeObj.removeAttr(m),$.isEmptyObject(h.typeObj.attr())&&h.removeAttr("typeObj"),window.localStorage.setItem("ordersInfo",JSON.stringify(h.attr())),O<=0&&window.location.replace("/orderList.html")},c=function(){var e=h.attr();delete e.typeObj[m][y],O<=0&&delete e.orderCount,$.isEmptyObject(e.typeObj[m])&&delete e.typeObj[m],$.isEmptyObject(e.typeObj)&&delete e.typeObj,window.localStorage.setItem("ordersInfo",JSON.stringify(e)),window.localStorage.removeItem("sendToYinLian"),window.localStorage.removeItem("sendToAliPay")};h.typeObj[m][y].attr("committed",!0),h.typeObj[m][y].attr("commitText","正在提交.."),"weChatPay"===e&&(i.type="JSAPI",i.payType=i.orderDetail.payType=1,o=function(e){r.jsUtil.weChat.toPay("JSAPI",e.obj,{success:a,cancel:a})}),"aliPay"===e&&(i.type="scanCode",i.payType=i.orderDetail.payType=2,o=function(e){if(e.obj){c();var o="string"==typeof e.obj?e.obj:JSON.stringify(e.obj);window.localStorage.setItem("sendToAliPay",o),window.location.href="/pay-transfer.html"}}),"ybPay"===e&&(i.type="",i.payType=i.orderDetail.payType=5,o=function(e){e.obj&&(window.location.href=e.obj.url)}),"unionPay"===e&&(i.type="08",i.payType=i.orderDetail.payType=3,o=function(e){if(e.obj){c();var o="string"==typeof e.obj?e.obj:JSON.stringify(e.obj);window.localStorage.setItem("sendToYinLian",o),window.location.href="/pay-transfer.html"}}),r.sendRequest("USER_DETAIL_QUERY").done(function(e){if(e&&e.success){if($.isPlainObject(e.obj))if($.isPlainObject(e.obj.userDetail)&&e.obj.userDetail.idNum){var a=0;0==m&&i.orderDetail.payment>t&&(1===i.orderGoodsList.length&&1===i.orderGoodsList[0].itemQuantity||(a=1)),0==a?(i.orderDetail.customerIdNum=e.obj.userDetail.idNum,i.orderDetail.customerName=e.obj.userDetail.name,i.orderDetail.customerPhone=e.obj.phone,r.sendRequest("ORDER_USER_CREATE",i).done(function(e){if(e&&e.success)O--,s.join(",")?r.sendRequest("ORDER_SHOPPINGCART_DELETE",{ids:s.join(",")}).done(function(){n(),o(e)}):(n(),o(e));else{p.refresh({type:"error",content:(e||{}).errorMsg||"提交订单失败！",cancelBtn:!1,confirmBtn:!1});var t={logsName:"orderSure",errorCode:"createOrder",errorMsg:e.errorMsg,detail:i.orderGoodsList,orderId:"订单未生成"};r.sendRequest("SET_DATA_LOGS",t),h.typeObj[m][y].attr("committed",!1),h.typeObj[m][y].attr("commitText","重新提交"),window.localStorage.setItem("ordersInfo",JSON.stringify(h.attr()))}}).fail(function(e){p.refresh({type:"error",content:(e||{}).errorMsg||"提交订单失败！",cancelBtn:!1,confirmBtn:!1});var o={logsName:"orderSure",errorCode:"createOrder",errorMsg:e.errorMsg,detail:i.orderGoodsList,orderId:"订单未生成"};r.sendRequest("SET_DATA_LOGS",o),h.typeObj[m][y].attr("committed",!1),h.typeObj[m][y].attr("commitText","重新提交"),window.localStorage.setItem("ordersInfo",JSON.stringify(h.attr()))})):1==a&&p.refresh({title:"温馨提示",content:"根据海关相关规定，单笔跨境订单金额不得超过"+t+"元，是否返回上页调整？",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){h.typeObj[m][y].attr("committed",!1),h.typeObj[m][y].attr("commitText","重新提交")},confirmFun:function(){r.jsUtil.url.jumpPage(d,null,!0)}})}else p.refresh({title:"实名认证",content:"跨境订单需填写身份证信息, 请完善!",DOMClick:!1,cancelBtn:!1,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){window.location.href="/personal-information.html?jumpUrl="+u}})}else p.refresh({title:"实名认证",content:"跨境订单需填写身份证信息, 请完善!",DOMClick:!1,cancelBtn:!1,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){window.location.href="/personal-information.html?jumpUrl="+u}})})})}})});