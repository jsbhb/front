define(["config.page.render"],function(e){"use strict";var n=window.capi.get();return e.extend({tags:{global:"<component-register-1></component-register-1>"},region:{global:{cfgDynamic:!0,reqDynamic:!0,resDynamic:!1}},config:{global:{isOpen:!1,isFocus:!1,iShopTimer:null}},request:{global:{account:"",validation:"",password:"",confirmPassword:""}},sendArr:[],reload:!1,".component-register-shopInfo #shopInfo input":function(e){var n=this,r=$(e),t=r.val(),o=n.renderData.global.config.attr("iShopTimer");clearTimeout(o),t?(o=setTimeout(function(){n.sendRequest("USER_CHOOSESHOP_QUERY",{name:t}).done(function(e){e&&e.success&&n.renderData.global.config.attr("iShopArr",e.obj||[])})},250),n.renderData.global.config.attr("iShopTimer",o)):n.renderData.global.config.attr("iShopArr",[]),n.renderData.global.config.attr("iShopId",""),n.renderData.global.config.attr("iDomain",""),n.renderData.global.config.attr("isFocus",!0)},".component-register-shopInfo #shopInfo blur":function(e){var n=this,r=$(e),t=r.val(),o=n.modules.message;t?n.sendRequest("USER_CHOOSESHOP_QUERY",{name:t}).done(function(e){e&&e.success?(n.renderData.global.config.attr("iShopArr",e.obj||[]),$.isEmptyObject(e.obj)&&o.refresh({type:"info",confirmBtn:!1,content:"暂未查询到与之相匹配的店铺！"})):e&&e.errorMsg?o.refresh({type:"error",confirmBtn:!1,content:e.errorMsg}):o.refresh({type:"info",confirmBtn:!1,content:"暂未查询到与之相匹配的店铺！"})}).fail(function(e){e&&e.errorMsg?o.refresh({type:"error",confirmBtn:!1,content:e.errorMsg}):o.refresh({type:"error",confirmBtn:!1,content:"查询店铺失败！"})}):n.renderData.global.config.attr("iShopArr",[]),n.renderData.global.config.attr("isFocus",!1)},".component-register-shopInfo #shopInfo touchend":function(e){var n=this,r=$(e),t=r.val();t?n.sendRequest("USER_CHOOSESHOP_QUERY",{name:t}).done(function(e){e&&e.success&&n.renderData.global.config.attr("iShopArr",e.obj||[])}):n.renderData.global.config.attr("iShopArr",[]),r.focus(),n.renderData.global.config.attr("isFocus",!0)},".component-register-shopInfo ul.choose li touchend":function(e){var r=this,t=$(e),o=t.attr("domain")||"",a=t.attr("shopId")||"",c=t.attr("shopName")||"",s=t.parents(".component-register-shopInfo");return n.jsEvent.touch.touchIsMoved||(s.find("#shopInfo").blur(),r.renderData.global.config.attr("isFocus",!1),r.renderData.global.config.attr("iShopId",a),r.renderData.global.config.attr("iDomain",o),r.renderData.global.config.attr("iShopName",c)),!1},".component-register-shopInfo .btn_change touchend":function(){var e=this,n=e.element,r=e.renderData.global.config.attr("isOpen");n.find("#shopInfo").blur(),e.renderData.global.config.attr("isOpen",!r),e.renderData.global.config.attr("iShopName",""),e.renderData.global.config.attr("iShopArr",[]),e.renderData.global.config.attr("iShopId",""),e.renderData.global.config.attr("iDomain","")},".component-register-account #account blur":function(e){var n=this,r=$(e),t=n.modules.message,o=n.renderData.global.request.attr();n.jsUtil.check.phone(o.account)&&n.jsUtil.weChat.browser()&&n.sendRequest("AUTH_CHECK",{userName:o.account,phone:o.account}).done(function(e){e&&!0===e.success&&1==e.obj?(t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"该手机号已被注册！"}),r.addClass("state_error")):r.removeClass("state_error")}).fail(function(){t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"未能查询到该手机号是否已注册！"}),r.removeClass("state_error")})},".component-register-validation .getValidation touchend":function(e){var n=this,r=$(e),t=n.element,o=n.modules.message,a=r.parents(".component-register-validation");t.find("#account").blur(),n.jsUtil.weChat.browser()?setTimeout(function(){var e=n.renderData.global.request.attr();!t.find("#account").hasClass("state_error")&&n.jsUtil.check.phone(e.account)&&n.sendRequest("THIRD_PHONE",{phone:e.account}).done(function(e){if(e&&e.success){var n=60,t=function(e){n>0?(n--,a.find(".doing .val").text(n),setTimeout(function(){t(e)},1e3)):e.addClass("getValidation")};r.removeClass("getValidation"),t(r)}else o.refresh({type:"warring",cancelBtn:!1,confirmBtn:!1,content:"验证码发送过于频繁"})}).fail(function(){o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"抱歉，手机验证码发送失败，请重试！"})})},200):o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"请在微信端进行操作！"})},".component-register-registerBtn:not(.state_error) touchend":function(){var e=this,r=e.element,t=e.modules.message,o=e.renderData.global.config.jumpUrl,a=r.find("#shopInfo").attr("domain")||"",c=r.find("#shopInfo").attr("shopId")||"";window.localStorage.removeItem("authId"),window.localStorage.removeItem("userId"),window.localStorage.removeItem("openId"),e.jsUtil.weChat.browser()?setTimeout(function(){var s=e.renderData.global.request.attr();!r.find("#account").hasClass("state_error")&&e.jsUtil.check.phone(s.account)&&e.sendRequest("USER_REGISTRATION",{phone:s.account,pwd:s.password,code:s.validation}).done(function(r){if(r&&r.success){var i=r.obj;e.sendRequest("AUTH_REGISTER",{phone:s.account,password:s.password,userCenterId:i}).done(function(r){if(r&&r.success){var s=n.jsData.location.hostUrl,i=s+"/wechat-transfer.html",l='"Bearer "'+r.obj.token,f=r.obj.userCenterId,d=!1+"，true，"+o+"，"+c+"，"+f+"，"+l+"，"+a;e.sendRequest("THIRD_WECHAT",{snsapiBase:!1,redirectUrl:i+"?info="+d}).done(function(e){"string"==typeof e&&(window.location.href=e)}),e.jsUtil.url.setParam({domain:a||""},"cover")}else r.errorMsg?t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:r.errorMsg}):t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"用户注册失败！"})}).fail(function(){t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"用户注册失败！"})})}else r&&1==r.obj?t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"验证码失效，请重试！"}):r.errorMsg?t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:r.errorMsg}):t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"用户注册失败！"})}).fail(function(){t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"用户注册失败！"})})},200):t.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"请在微信端进行操作！"})}})});