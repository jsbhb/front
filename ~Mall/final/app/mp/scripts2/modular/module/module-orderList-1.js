define(["config.page.render"],function(e){"use strict";var r=window.capi.get();return e.extend({tags:{global:"<component-orderlist-1></component-orderlist-1>",payChoose:"<component-pay-choose-1></component-pay-choose-1>"},region:{global:{cfgDynamic:!0,reqDynamic:!1,resDynamic:!0,beforeFunc:function(e,r){var t=0,n=0,o=0,a=0,l=r.response.global.orderInfo||{};$.each(r.response.global.orderStatus,function(e,r){var l=r.status,s=r.total;0===l?t+=s:1===l||2===l||3===l||4===l||5===l||11===l||12===l?n+=s:6===l?o+=s:7===l&&(a+=s)}),e.config.global.currentPage=(l.pagination||{}).currentPage,e.config.global.totalPages=(l.pagination||{}).totalPages,e.response.global.orderStatus={needPay:t,needDeliver:n,needReceived:o,finish:a}},afterFunc:function(e,r){e.config.global.currentPage===e.config.global.totalPages?$(e.element).find(".isLoading span").text("没有更多数据了..."):$(e.element).find(".isLoading span").text("请下拉加载...")}},payChoose:{cfgDynamic:!0}},config:{global:{siteInfo:r.jsData.siteInfo},payChoose:{payChooseShow:!1,payState:null}},request:{global:{},ORDER_USER_QUERY:{numPerPage:5,currentPage:1}},response:{global:{}},sendArr:["ORDER_USER_QUERY/global/orderInfo","ORDER_USER_STATUS_COUNT/global/orderStatus"],reload:!1,".component-orderList-content       span.state touchend":function(e){var r=this,t=$(e),n=r.modules.message;t.hasClass("active")||(t.hasClass("state_all")?(delete r.request.ORDER_USER_QUERY.status,delete r.request.ORDER_USER_QUERY.statusArr,r.request.ORDER_USER_QUERY.currentPage=1,r.renderData.global.config.attr("orderAll","active"),r.renderData.global.config.attr("orderNeedPay",null),r.renderData.global.config.attr("orderNeedDeliver",null),r.renderData.global.config.attr("orderNeedReceive",null),r.renderData.global.config.attr("orderFinished",null),r.jsUtil.url.delParam(["queryType"],"cover")):t.hasClass("state_needPay")?(r.request.ORDER_USER_QUERY.status=0,r.request.ORDER_USER_QUERY.currentPage=1,delete r.request.ORDER_USER_QUERY.statusArr,r.renderData.global.config.attr("orderAll",null),r.renderData.global.config.attr("orderNeedPay","active"),r.renderData.global.config.attr("orderNeedDeliver",null),r.renderData.global.config.attr("orderNeedReceive",null),r.renderData.global.config.attr("orderFinished",null),r.jsUtil.url.setParam({queryType:"needPay"},"cover")):t.hasClass("state_needDeliver")?(delete r.request.ORDER_USER_QUERY.status,r.request.ORDER_USER_QUERY.currentPage=1,r.request.ORDER_USER_QUERY.statusArr="1,2,3,4,5,11,12",r.renderData.global.config.attr("orderAll",null),r.renderData.global.config.attr("orderNeedPay",null),r.renderData.global.config.attr("orderNeedDeliver","active"),r.renderData.global.config.attr("orderNeedReceive",null),r.renderData.global.config.attr("orderFinished",null),r.jsUtil.url.setParam({queryType:"needDeliver"},"cover")):t.hasClass("state_needReceive")?(r.request.ORDER_USER_QUERY.status=6,r.request.ORDER_USER_QUERY.currentPage=1,delete r.request.ORDER_USER_QUERY.statusArr,r.renderData.global.config.attr("orderAll",null),r.renderData.global.config.attr("orderNeedPay",null),r.renderData.global.config.attr("orderNeedDeliver",null),r.renderData.global.config.attr("orderNeedReceive","active"),r.renderData.global.config.attr("orderFinished",null),r.jsUtil.url.setParam({queryType:"needReceived"},"cover")):t.hasClass("state_finished")&&(r.request.ORDER_USER_QUERY.status=7,r.request.ORDER_USER_QUERY.currentPage=1,delete r.request.ORDER_USER_QUERY.statusArr,r.renderData.global.config.attr("orderAll",null),r.renderData.global.config.attr("orderNeedPay",null),r.renderData.global.config.attr("orderNeedDeliver",null),r.renderData.global.config.attr("orderNeedReceive",null),r.renderData.global.config.attr("orderFinished","active"),r.jsUtil.url.setParam({queryType:"finished"},"cover")),r.toRender(["ORDER_USER_QUERY/global/orderInfo","ORDER_USER_STATUS_COUNT/global/orderStatus"],[{},{}],[{global:["response"]},"pagination"]).done(function(){$("html,body").animate({scrollTop:0},300)}).fail(function(){n.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"获取失败，请重试！"})}))},".component-orderList-orderDetails .btn_confirmDelivery touchend":function(e){var r=this,t=$(e),n=t.attr("orderId"),o=r.modules.message;r.request.ORDER_USER_CONFIRM.orderId=n,o.refresh({type:"info",language:"zh",content:"该订单是否确认收货？",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){r.sendRequest("ORDER_USER_CONFIRM").done(function(e){e&&e.success?r.toRender(["ORDER_USER_QUERY/global/orderInfo","ORDER_USER_STATUS_COUNT/global/orderStatus"],[{},{}],[{global:["response"]},"pagination"]):o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:e&&e.errorMsg||"确认收货失败！"})}).fail(function(e){o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:e&&e.errorMsg||"确认收货失败！"})})}})},".component-orderList-orderDetails .btn_closeOrder touchend":function(e){var r=this,t=$(e),n=t.attr("orderId"),o=r.modules.message;r.request.ORDER_USER_CLOSE.orderId=n,o.refresh({type:"info",language:"zh",content:"是否关闭该订单？请确认！",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){r.sendRequest("ORDER_USER_CLOSE").done(function(e){e&&e.success?r.toRender(["ORDER_USER_QUERY/global/orderInfo","ORDER_USER_STATUS_COUNT/global/orderStatus"],[{},{}],[{global:["response"]},"pagination"]):o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:e&&e.errorMsg||"关闭订单失败！"})}).fail(function(e){o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:e&&e.errorMsg||"关闭订单失败！"})})}})},".component-orderList-orderDetails .btn_delOrder touchend":function(e){var r=this,t=$(e),n=t.attr("orderId"),o=r.modules.message;r.request.ORDER_USER_DELETE.orderId=n,o.refresh({type:"info",language:"zh",content:"是否删除该订单？请确认！",DOMClick:!1,cancelBtn:!0,confirmBtn:!0,cancelFun:function(){},confirmFun:function(){r.sendRequest("ORDER_USER_DELETE").done(function(e){e&&e.success?r.toRender(["ORDER_USER_QUERY/global/orderInfo","ORDER_USER_STATUS_COUNT/global/orderStatus"],[{},{}],[{global:["response"]},"pagination"]):o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"订单确认失败！"})}).fail(function(e){e&&e.errorMsg&&o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:e.errorMsg||"订单确认失败！"})})}})},".component-orderList-orderDetails .btn_refund touchend":function(){var e=this,r=e.modules.message,t=e.renderData.global.config.siteInfo.attr()||{};t.qq?window.open("http://wpa.qq.com/msgrd?v=3&uin="+t.qq+"&site=qq&menu=yes"):r.refresh({content:"暂时无法联系客服!",confirmBtn:!1})},".component-orderList-orderDetails .btn_toPay touchend":function(e){var t=this,n=$(e),o=t.modules.message,a=t.config.global.redirect,l=n.attr("orderId"),s=n.attr("orderFlag"),i=localStorage.getItem("openId");if(r.jsEvent.touch.focusTime<=300)return null;t.renderData.payChoose.config.attr("payChooseShow",!0),t.renderData.payChoose.config.attr("orderFlag",s),t.renderData.payChoose.config.attr("payState",$.Deferred()),$.when(t.renderData.payChoose.config.attr().payState).done(function(e){var r="",n="",s=function(){},c=function(){setTimeout(function(){window.location.replace(window.location.href)},200)};"weChatPay"===e&&(r="JSAPI",n=1,s=function(e){t.jsUtil.weChat.toPay("JSAPI",e.obj,{success:c})}),"aliPay"===e&&(r="scanCode",n=2,s=function(e){if(e.obj){var r="string"==typeof e.obj?e.obj:JSON.stringify(e.obj);window.localStorage.setItem("sendToAliPay",r),window.location.href="/pay-transfer.html"}}),"ybPay"===e&&(r="",n=5,s=function(e){e.obj&&(window.location.href=e.obj)}),"unionPay"===e&&(r="08",n=3,s=function(e){if(e.obj){var r="string"==typeof e.obj?e.obj:JSON.stringify(e.obj);window.localStorage.setItem("sendToYinLian",r),window.location.href="/pay-transfer.html"}}),t.sendRequest("PAY_ORDER",{orderId:l,payType:n,type:r,openId:i,redirect:a}).done(function(r){r&&r.success?s(r):r&&r.errorMsg?o.refresh({content:r.errorMsg,confirmBtn:!1}):"weChatPay"===e&&o.refresh({content:"该订单已被微信关闭，请手动关闭该订单！",confirmBtn:!1})}).fail(function(){o.refresh({type:"error",cancelBtn:!1,confirmBtn:!1,content:"支付失败！"})})})},".component-orderList-orderDetails .btn_viewLogistics touchend":function(e){var r=this,t=$(e),n=r.modules.message,o=r.renderData.global.response.orderInfo.orderList.attr(),a=t.attr("orderId"),l=null;if($.each(o||{},function(e,r){if(a===r.orderId)return l=r,!1}),l){var s=!1,i=l.orderExpressList||[];$.each(i,function(e,r){if(r.expressId&&r.expressName)return s=!0,!1}),s?window.location.href="/logistics.html?orderId="+a:n.refresh({cancelBtn:!1,confirmBtn:!1,content:"暂无物流信息！"})}else n.refresh({cancelBtn:!1,confirmBtn:!1,content:"暂无物流信息！"})},"{window}   scroll":function(){var e=this,r=$(document),t=e.config.global.totalPages,n=e.config.global.currentPage,o=e.request.ORDER_USER_QUERY.currentPage,a=n===t,l=n<o,s=$(window).scrollTop()+$(window).height()+350>$(document).height();a?r.find(".isLoading span").text("没有更多数据了..."):r.find(".isLoading span").text("请下拉加载..."),!s||a||l||(e.request.ORDER_USER_QUERY.currentPage++,e.sendRequest("ORDER_USER_QUERY",{currentPage:n+1}).done(function(t){if(t&&t.success){var n=t.obj;$.each(n.orderList,function(r,t){e.renderData.global.response.orderInfo.orderList.push(t)}),n.pagination.currentPage===n.pagination.totalPages&&r.find(".isLoading span").text("没有更多数据了..."),e.config.global.currentPage=n.pagination.currentPage,e.config.global.totalPages=n.pagination.totalPages}}))}})});